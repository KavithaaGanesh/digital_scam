import requests
import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials

# üîê Google Sheets Config
GSHEET_NAME = "Digital_Scam_Alerts"
TAB_NAME = "Phishing_Live"
JSON_KEY_FILE = "C:\\Users\\Dell\\Downloads\\digital-scam-1685dc844428.json"

# 1Ô∏è‚É£ Fetch PhishTank Data
def fetch_phishing_data():
    print("üåê Fetching real-time phishing data...")
    url = "http://data.phishtank.com/data/online-valid.json"
    res = requests.get(url)
    data = res.json()
    df = pd.DataFrame(data)[["url", "submission_time", "verified", "phish_detail_url", "target"]]
    df["submission_time"] = pd.to_datetime(df["submission_time"])
    df["Date"] = df["submission_time"].dt.date
    df["Source"] = "PhishTank"
    print(f"‚úÖ Loaded {len(df)} phishing URLs.")
    return df

# 2Ô∏è‚É£ Connect to Google Sheet
def connect_gsheet(sheet_name):
    scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
    creds = ServiceAccountCredentials.from_json_keyfile_name(JSON_KEY_FILE, scope)
    client = gspread.authorize(creds)
    return client.open(sheet_name)

# 3Ô∏è‚É£ Push Data to Sheet
def write_to_gsheet(sheet, tab_name, df):
    if df.empty:
        print(f"‚ö†Ô∏è No data to write for {tab_name}.")
        return
    try:
        # Convert datetime-like columns to string
        df = df.copy()
        for col in df.columns:
            if pd.api.types.is_datetime64_any_dtype(df[col]) or pd.api.types.is_timedelta64_dtype(df[col]):
                df[col] = df[col].astype(str)

        try:
            ws = sheet.worksheet(tab_name)
            sheet.del_worksheet(ws)
        except:
            pass

        ws = sheet.add_worksheet(title=tab_name, rows=str(len(df)+1), cols=str(len(df.columns)))
        ws.update([df.columns.values.tolist()] + df.values.tolist())
        print(f"‚úÖ {tab_name} updated ({len(df)} rows).")
    except Exception as e:
        print(f"‚ùå Error writing to {tab_name}:", e)

# 4Ô∏è‚É£ Main
def main():
    df = fetch_phishing_data()
    sheet = connect_gsheet(GSHEET_NAME)
    write_to_gsheet(sheet, TAB_NAME, df)

if __name__ == "__main__":
    main()
